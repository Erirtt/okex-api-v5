<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>å®æ—¶å…¥åœºå€™é€‰ & 1m K çº¿</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { padding: 2rem; }
    #chart { height: 500px; }
    .reason-card { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h1 class="mb-4">ğŸš€ å®æ—¶å…¥åœºå€™é€‰ & 1m K çº¿</h1>
    <div class="row">
      <!-- å·¦ä¾§ï¼šåˆæ­¥ & æœ€ç»ˆåˆ—è¡¨ -->
      <div class="col-md-4">
        <div class="mb-4">
          <h5>1ï¸âƒ£ åˆæ­¥ç­›é€‰</h5>
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr><th>Symbol</th><th>Î”24h</th><th>Vol24h</th></tr>
            </thead>
            <tbody id="prelim-table"></tbody>
          </table>
        </div>
        <div>
          <h5>2ï¸âƒ£ æœ€ç»ˆå…¥åœºå€™é€‰</h5>
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr><th>Symbol</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="final-table"></tbody>
          </table>
        </div>
      </div>

      <!-- å³ä¾§ï¼šç†ç”± + K çº¿ -->
      <div class="col-md-8">
        <div id="reason-container" class="card reason-card d-none">
          <div class="card-header bg-primary text-white">é€‰ä¸­ç†ç”±</div>
          <div class="card-body">
            <p id="reason-text" class="mb-0"></p>
          </div>
        </div>
        <div id="chart" class="border"></div>
      </div>
    </div>
  </div>

  <script>
    async function fetchCandidates(){
      const res = await fetch('/api/candidates');
      return await res.json();
    }
    async function fetchKline(sym){
      const res = await fetch(`/api/kline?symbol=${encodeURIComponent(sym)}`);
      return await res.json();
    }

    function renderPrelim(list){
      const tb = document.getElementById('prelim-table');
      tb.innerHTML = '';
      if(!list.length){
        tb.innerHTML = '<tr><td colspan="3" class="text-center text-muted">â€” æ—  â€”</td></tr>';
        return;
      }
      list.forEach(i=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i.symbol}</td>
          <td>${i.change24h.toFixed(2)}%</td>
          <td>${i.vol24h.toLocaleString()}</td>
        `;
        tb.appendChild(tr);
      });
    }

    function renderFinal(list){
      const tb = document.getElementById('final-table');
      tb.innerHTML = '';
      if(!list.length){
        tb.innerHTML = '<tr><td colspan="2" class="text-center text-muted">â€” æ—  â€”</td></tr>';
        return;
      }
      list.forEach(item=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.symbol}</td>
          <td><button class="btn btn-sm btn-primary">æŸ¥çœ‹</button></td>`;
        tr.querySelector('button').onclick = () => selectSymbol(item);
        tb.appendChild(tr);
      });
    }

    async function selectSymbol(item){
      // æ˜¾ç¤ºç†ç”±
      const rc = document.getElementById('reason-container');
      document.getElementById('reason-text').innerText = item.reason;
      rc.classList.remove('d-none');

      // ç”» K çº¿
      const data = await fetchKline(item.symbol);
      const trace = {
        x: data.ts,
        open: data.open, high: data.high,
        low: data.low, close: data.close,
        type: 'candlestick',
        increasing: {line:{color:'green'}},
        decreasing: {line:{color:'red'}}
      };
      const layout = {
        title: `${item.symbol} æœ€è¿‘60æ ¹1m K çº¿`,
        xaxis:{rangeslider:{visible:false}},
        margin:{t:30,l:40,r:20,b:40}
      };
      Plotly.newPlot('chart',[trace],layout,{responsive:true});
    }

    // åˆ·æ–°æ‰€æœ‰
    async function refreshAll(){
      const {prelim, final} = await fetchCandidates();
      renderPrelim(prelim);
      renderFinal(final);
      // éšè—ä¸Šä¸€æ¡ç†ç”±å’Œå›¾
      document.getElementById('reason-container').classList.add('d-none');
      document.getElementById('chart').innerHTML = '';
    }

    // åˆå§‹åŒ– & å®šæ—¶ 30 åˆ†é’Ÿåˆ·æ–°
    refreshAll();
    setInterval(refreshAll, 30*60*1000);
  </script>
</body>
</html>
