<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>候选标的与1H K线</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    /* 网格布局，多列自适应 */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: #ffffff;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .card h2 {
      margin: 0 0 .5rem;
      font-size: 1.2rem;
    }
    .plan {
      font-size: 0.9rem;
      color: #333;
      margin-bottom: .75rem;
      line-height: 1.4;
    }
    /* 缩小画布高度 */
    canvas {
      width: 100% !important;
      height: 150px !important;
    }
  </style>
</head>
<body>

  <h1>📈 最终候选标的</h1>
  {% if not candidates %}
    <p style="text-align:center;">暂无候选，请稍后刷新。</p>
  {% endif %}

  <div class="cards">
    {% for c in candidates %}
    <div class="card">
      <h2>{{ c.symbol }}</h2>
      <p class="plan">
        {% if c.score is defined %}
          <strong>评分:</strong> {{ c.score }}&nbsp;&nbsp;
        {% endif %}
        {% if c.entry is defined %}
          <strong>入场:</strong> {{ c.entry }}&nbsp;&nbsp;
        {% endif %}
        {% if c.stop_loss is defined %}
          <strong>止损:</strong> {{ c.stop_loss }}&nbsp;&nbsp;
        {% endif %}
        {% if c.take_profit is defined %}
          <strong>止盈:</strong> {{ c.take_profit }}
        {% endif %}
      </p>
      <canvas id="chart-{{ c.symbol|replace('-', '_') }}"></canvas>
    </div>
    {% endfor %}
  </div>

  <script>
    // 后端传来的图表数据 JSON
    const chartData = {{ chart_data|safe }};

    document.addEventListener("DOMContentLoaded", () => {
      {% for c in candidates %}
      (function() {
        const sym = "{{ c.symbol }}";
        const dataArr = chartData[sym] || [];
        const ctx = document.getElementById("chart-{{ c.symbol|replace('-', '_') }}").getContext('2d');

        if (!dataArr.length) {
          ctx.font = "14px sans-serif";
          ctx.fillText("暂无历史K线数据", 10, 50);
          return;
        }

        const labels = dataArr.map(d => d.ts);
        const closes = dataArr.map(d => d.close);

        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: sym + " 收盘价",
              data: closes,
              borderColor: 'rgba(33,150,243,1)',
              backgroundColor: 'rgba(33,150,243,0.1)',
              pointRadius: 0,
              borderWidth: 1.2,
              fill: true,
              tension: 0.2
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: { display: true, title: { display: true, text: '时间' },
                   ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 } },
              y: { display: true, title: { display: true, text: '价格' } }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => `收盘: ${ctx.parsed.y}`
                }
              }
            }
          }
        });
      })();
      {% endfor %}
    });
  </script>

</body>
</html>
